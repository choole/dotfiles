"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[71],{73240:(e,t,i)=>{i.r(t),i.d(t,{default:()=>de});var o=i(10434),n=i.n(o),r=i(23174),s=i.n(r),a=(i(21703),i(96486)),l=i.n(a),d=i(67294),p=i(83355),h=i(99036),u=i(8848),c=i(84682),m=i(18955),g=i(91905),y=i(42875),f=i(55384),S=i(82990),v=i(5366),b=i(50906),C=i(62134),x=i(66890),M=i(75079),k=i(87279),T=i(33665),F=i(77907),I=i(34859),w=i(79315),L=i(49085);class D extends L.default{getInitialState(){return{value:"",html:"",query:""}}}const Z=D;var E=i(29798),W=i(48019),P=i(78140),R=i(40721),B=i(18647),N=i(72495),z=i(13991),H=i(76725);class O extends p.Z{renderDescription(){const{entry:e}=this.props;if(e){const{descriptionMessage:t,fallbackDescription:i}=e;if(t)return d.createElement(v.FormattedMessage,t);if(i)return i}return null}renderComponent(){const{entry:e}=this.props;if(e){const{name:t,examples:i}=e,o=(0,m.EP)(this.props.Prism,(i||[]).join("\n")),n=this.renderSyntax();return s()("div",{},void 0,s()("h1",{style:O.headerStyle},void 0,t),s()("p",{style:O.textStyle},void 0,this.renderDescription()),s()("p",{style:O.textStyle},void 0,s()("b",{},void 0,s()(v.FormattedMessage,{id:"database.formula.syntaxSection.title",defaultMessage:"Syntax"}))),s()("pre",{style:this.getCodeStyle()},void 0,(0,H.Z)(n,(e=>s()("br",{},`sep:${e}`)))),i&&i.length>0&&s()("p",{style:O.textStyle},void 0,s()("b",{},void 0,s()(v.FormattedMessage,{id:"database.formula.examplesSection.title",defaultMessage:"Examples"}))),s()("pre",{style:this.getCodeStyle(),dangerouslySetInnerHTML:{__html:o}}))}return s()("div",{})}renderSyntax(){const{entry:e}=this.props;if(!e)return[];const{name:t,category:i}=e;return i===g.WD.property?[s()("span",{},0,"prop(",JSON.stringify(t),")")]:i===g.WD.constant?[s()("span",{},0,t)]:i===g.WD.function?this.getFunctionSyntax(e):i===g.WD.operator?this.getOperatorSyntax(e):[]}getFunctionSyntax(e){const{name:t}=e;return O.getSignatureNames(e).map(((e,i)=>{let{variadic:o,arity:n}=e;return o?s()("span",{},i,t,"(",s()("i",{},void 0,o),"...)"):s()("span",{},i,t,"(",(0,H.Z)(n.map(((e,t)=>s()("i",{},t,e))),(e=>s()("span",{},`sep:${e}`,","," "))),")")}))}getOperatorSyntax(e){const{operator:t}=e;return l().compact(O.getSignatureNames(e).map(((e,i)=>{let{arity:o}=e;if(1===o.length){const[e]=o;return s()("span",{},-i-1,t," ",s()("i",{},void 0,e))}if(2===o.length){const[e,n]=o;return s()("span",{},-i-1,s()("i",{},void 0,e)," ",t," ",s()("i",{},void 0,n))}if(3===o.length){const[e,t,n]=o;return s()("span",{},-i-1,s()("i",{},void 0,e)," ","? ",s()("i",{},void 0,t)," ",": ",s()("i",{},void 0,n))}})).concat(this.getFunctionSyntax(e)))}static getSignatureNames(e){const{name:t,signatures:i}=e;return"if"===t?[{arity:["boolean","value","value"]}]:"format"===t||"unaryPlus"===t?[{arity:["value"]}]:"equal"===t||"unequal"===t?[{arity:["value","value"]}]:i.map((e=>{let{arity:t,variadic:i}=e;return{variadic:i?O.typeNameMap[i]:void 0,arity:t?l().compact(t.map((e=>O.typeNameMap[e]))):[]}}))}getCodeStyle(){return{paddingTop:6,paddingBottom:8,paddingLeft:10,paddingRight:10,overflowX:"scroll",background:this.theme.sidebarBackground,borderRadius:3,fontSize:13,margin:0,fontFamily:S.Z.getCompositeFontFamily(z.SP).mono,lineHeight:1.4}}}O.displayName="FormulaDocumentation",O.typeNameMap={checkbox:"boolean",number:"number",text:"text",date:"date"},O.headerStyle={fontSize:20,margin:0,lineHeight:1,marginTop:4,marginBottom:12},O.textStyle={whiteSpace:"normal",marginTop:8,marginBottom:8,fontSize:13,lineHeight:1.4};const U=(0,F.withDependency)(F.deps.prismjs,((e,t)=>d.createElement(O,n()({},t,{Prism:e}))));var $=i(39068),K=i(53397),_=i(64921),q=i(52275),A=i(31945),j=i(28992);class G extends p.Z{renderComponent(){const{entry:{name:e}}=this.props;return s()(q.Z,{focused:this.props.focused,onClick:this.props.onClick,onMouseEnter:this.props.onMouseEnter,icon:s()("div",{style:{...$.f,...this.environment.device.isMobile&&{marginLeft:14}}},void 0,this.renderPropertyIcon()),title:e,right:this.renderDocumentationButtonPopup(),style:{...!this.environment.device.isMobile&&{paddingLeft:8,paddingRight:8}},desktopIconStyle:{marginLeft:0}})}renderDocumentationButtonPopup(){const{device:e}=this.environment;if(this.environment.device.isMobile)return s()(A.ZP,{popupType:e.isMobile?A.Z4.SlideUp:A.Z4.Popup,renderOrigin:e=>d.createElement(_.Z,n()({mobileFeedback:!0,style:{width:16,height:16}},e),K.Z.typesUnknownType({fill:this.theme.mediumIconColor})),render:t=>{let i;return i=e.isMobile?{menuType:k.og.Modal,title:s()(v.FormattedMessage,{defaultMessage:"Documentation",id:"database.formulaPropertyEntryMenuItem.title"}),right:s()(R.DoneMenuText,{}),onClickRight:t.close}:{menuType:k.og.Popup},d.createElement(P.Z,i,s()(N.Z,{},void 0,s()(j.Z,{title:s()(U,{entry:this.props.entry}),style:{paddingTop:10,paddingBottom:16}})))}})}renderPropertyIcon(){const{entry:e}=this.props,{theme:t}=this;if(e.category===g.WD.property||e.category===g.WD.constant){const{resultType:i}=e;return s()($.ZP,{type:i,icon:void 0,size:16,theme:t})}if(e.category===g.WD.function||e.category===g.WD.operator){const{signatures:[{resultType:i}]}=e;return s()($.ZP,{type:i,icon:void 0,size:16,theme:t})}}}G.displayName="FormulaEntryMenuItem",G.contextTypes={...k.mw,...p.w};const J=G;var Y=i(63143),V=i(52821),Q=i(45023),X=i(33929),ee=i(80935),te=i(42922),ie=i(3386),oe=i(58032);const ne=(0,v.defineMessages)({placeholder:{id:"database.formula.placeholder",defaultMessage:"Type a formula"}});class re extends p.Z{constructor(){super(...arguments),this.updateTimer=void 0,this.latestSelectionRange=void 0,this.storeTypes={store:Z},this.handleSelectionChange=()=>{const e=ee.get();e&&this.input.contains(e.commonAncestorContainer)&&(this.latestSelectionRange=e)},this.handleInputMount=e=>this.input=e,this.handleInput=e=>{const{target:{textContent:t}}=e;this.updateValue(t),Y.z4(this.updateTimer)&&(this.updateTimer=window.setTimeout((()=>this.executeUpdate()),re.delay))},this.handlePaste=e=>{e.preventDefault();const t=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,t)},this.handleKeyUp=e=>{this.updateSelection()},this.handleClick=e=>{this.updateSelection()},this.handleKeyDown=e=>{(0,Q.Z)(this.environment,e,"command+enter")&&(this.handleAccept(),e.stopPropagation())},this.getStyle=()=>({flexGrow:1,position:"relative",minWidth:0,...this.props.inputContainerStyle})}insertEntry(e){var t,i;const{value:o}=this.stores.store.state,{name:n}=e,r=re.getCompletion(e),s=(null===(t=this.latestSelectionRange)||void 0===t?void 0:t.startOffset)??0;let a=s,l=(null===(i=this.latestSelectionRange)||void 0===i?void 0:i.endOffset)??0;const d=m.wo(o,s);if(d){const[e,t]=d,i=o.slice(e,t).toLowerCase();i!==r.toLowerCase().slice(0,t-e)&&i!==n.toLowerCase().slice(0,t-e)||(a=e,l=t)}this.input.focus();const p=this.input.firstChild||this.input,h=document.createRange();h.setStart(p,a),h.setEnd(p,l),ee.set(h,this.environment.device),a<l&&document.execCommand("delete",!1),document.execCommand("insertText",!1,r);const u=(l+r.length)/(this.input&&this.input.textContent&&this.input.textContent.length||0)*this.container.scrollWidth;u>this.container.scrollLeft+this.container.offsetWidth&&(this.container.scrollLeft=u-this.container.offsetWidth)}handleAccept(){this.updateTimer&&(window.clearTimeout(this.updateTimer),this.updateTimer=void 0);const{value:e}=this.stores.store.state;if(""===e.trim())this.props.onSubmit();else{const{formula:t,error:i}=this.updateFormula(e);i||this.props.onSubmit(t)}}willMount(e){super.willMount(e);const{formula:t,schema:i}=e,o=this.props.formulaStringHelpers.formulaToString(t,i);this.updateValue(o)}didMount(){const{device:e}=this.environment,{value:t}=this.stores.store.state;if(this.input&&(this.input.textContent=t,e.isMobile||this.input.focus(),t)){const e=document.getSelection();this.input.firstChild&&e.collapse(this.input.firstChild,t.length),this.container.scrollLeft=this.container.scrollWidth-this.container.offsetWidth}document.addEventListener("selectionchange",this.handleSelectionChange)}willUnmount(){document.removeEventListener("selectionchange",this.handleSelectionChange)}renderComponent(){const{device:e}=this.environment,{disabled:t}=this.props,{command:i}=C.fg(this.environment),{html:o}=this.stores.store.state;return s()("div",{style:this.getWrapStyle()},void 0,d.createElement("div",{ref:e=>{e&&(this.container=e)},style:this.getStyle()},s()(ie.Z,{capture:!t,onLeft:l().identity,onRight:l().identity,onSelectAll:l().identity,onRedo:l().identity,onUndo:l().identity,onToggleBold:l().identity,onToggleItalics:l().identity,onToggleCode:l().identity,onCut:l().identity,onCopy:l().identity,onPaste:l().identity,onKeypress:l().identity,onDelete:l().identity,onBackspace:l().identity},void 0,d.createElement("div",{ref:this.handleInputMount,contentEditable:!t,spellCheck:!1,autoCorrect:"off",autoCapitalize:"off",onClick:this.handleClick,onKeyUp:this.handleKeyUp,onKeyDown:this.handleKeyDown,onInput:this.handleInput,onPaste:this.handlePaste,style:this.getInputStyle()})),s()("div",{style:this.getOverlayStyle(),dangerouslySetInnerHTML:{__html:o}})),!e.isMobile&&!t&&s()(oe.Z,{renderTooltip:()=>s()("div",{},void 0,s()("span",{},void 0,s()(v.FormattedMessage,{defaultMessage:"Accept",id:"database.formula.acceptFormulaInput.tooltip"}))," ",s()("span",{style:{color:this.theme.mediumInvertedTextColor}},void 0,i,"+Enter")),render:t=>d.createElement(te.Z,n()({disabled:Boolean(this.stores.store.state.error),onClick:()=>this.handleAccept(),style:{height:24,padding:"0 8px",alignSelf:"flex-end",marginRight:6,marginBottom:4,...e.isMobile&&{marginRight:12}}},t),s()(v.FormattedMessage,{id:"database.formula.doneButton.label",defaultMessage:"Done"}))}))}updateValue(e){const t=""===e.trim()?this.props.disabled?"":X.default.formatMessage(ne.placeholder):m.EP(this.props.Prism,e);this.stores.store.setState({...this.stores.store.state,html:t,value:e})}updateSelection(){const e=document.getSelection().anchorOffset,{value:t}=this.stores.store.state,i=m.wo(t,e),o=i?t.slice(i[0],i[1]):"";o!==this.stores.store.state.query&&this.stores.store.setState({...this.stores.store.state,query:o})}updateFormula(e){const{schema:t,property:i}=this.props;if(""===e.trim())return{error:void 0,formula:void 0,type:void 0};{const o=this.props.formulaStringHelpers.stringToFormula({str:e,property:i,schema:t,intl:X.default.getIntl(),propertyTypeDisplayName:V.SO});if(o&&"error"===o.type){const{message:e}=o;return{formula:void 0,error:e,type:void 0}}return{formula:o,error:void 0,type:void 0}}}executeUpdate(){const{value:e}=this.stores.store.state,{error:t,formula:i}=this.updateFormula(e);!t&&i&&this.props.onChange(i),this.updateTimer=void 0,this.stores.store.setState({...this.stores.store.state,error:t})}static getCompletion(e){const{category:t,name:i}=e;return t===g.WD.property?`prop(${JSON.stringify(i)})`:t===g.WD.constant?i:`${i}(`}getWrapStyle(){const{device:e,WindowSizeStore:t}=this.environment;return{display:"flex",flex:"none",background:this.theme.inputBackground,minHeight:33,borderTopLeftRadius:3,borderTopRightRadius:3,...this.props.disabled&&{background:this.theme.contentBackground,borderRadius:3},...e.isMobile&&{borderBottom:`1px solid ${this.theme.regularDividerColor}`,background:this.theme.popoverBackground,minHeight:44,paddingLeft:t.state.paddingLeftCSS,paddingRight:t.state.paddingRightCSS},...this.props.wrapStyle}}getOverlayStyle(){const{device:e}=this.environment,{value:t}=this.stores.store.state;return{...e.isMobile?re.mobileInputStyle:re.desktopInputStyle,zIndex:0,...""===t.trim()&&{color:this.theme.mediumTextColor},position:void 0}}getInputStyle(){const{device:e}=this.environment,t=e.isSafari||e.isChrome?"WebkitTextFillColor":"color";return{...e.isMobile?re.mobileInputStyle:re.desktopInputStyle,border:"none",background:"none",[t]:""===this.stores.store.state.value?this.theme.regularTextColor:u.ZP.transparent,caretColor:this.theme.regularTextColor,zIndex:1,width:"100%"}}}re.displayName="FormulaInput",re.delay=0,re.desktopInputStyle={alignItems:"center",position:"absolute",minWidth:"100%",minHeight:32,margin:0,padding:0,paddingLeft:10,paddingRight:8,paddingTop:8,fontSize:13,fontFamily:S.Z.getCompositeFontFamily(z.SP).mono,wordWrap:"break-word"},re.mobileInputStyle={alignItems:"center",position:"absolute",minWidth:"100%",minHeight:44,margin:0,paddingLeft:16,paddingRight:0,paddingTop:12,paddingBottom:12,fontSize:14,fontFamily:S.Z.getCompositeFontFamily(z.SP).githubMono};const se=re;var ae=i(74523);class le extends p.Z{constructor(){super(...arguments),this.storeTypes={formulaInputStore:Z,menuListStore:E.Z},this.state={filteredSections:[]},this.handleFilteredSectionsChange=e=>{l().isEqual(e.map((e=>e.key)),this.state.filteredSections.map((e=>e.key)))||this.setState({filteredSections:e})}}renderComponent(){const{device:e}=this.environment,{schema:t,property:i,disabled:o}=this.props,{error:n}=this.stores.formulaInputStore.state,{formula:r}=t[i],a=s()(d.Fragment,{},void 0,s()(F.DependencyConsumer,{dependency:F.deps.prismjs},void 0,(e=>s()(F.DependencyConsumer,{dependency:F.deps.formulaStringHelpers},void 0,(n=>d.createElement(se,{ref:e=>{e&&(this.formulaInput=e)},Prism:e,formulaStringHelpers:n,store:this.stores.formulaInputStore,formula:r,schema:t,property:i,disabled:o,onChange:e=>this.handleInputChange(e),onSubmit:e=>this.handleInputSubmit(e),wrapStyle:{overflow:"hidden"},inputContainerStyle:{maxHeight:"45vh",overflow:"scroll"}}))))),e.isMobile&&this.renderStatus());let l;return l=e.isMobile?{menuType:k.og.Modal,title:s()(v.FormattedMessage,{id:"database.mobileFormulaModal.title",defaultMessage:"Formula"}),left:s()(R.CancelMenuText,{}),right:n?void 0:s()(v.FormattedMessage,{id:"database.mobileFormulaModal.saveButton.label",defaultMessage:"Save"}),onClickLeft:this.props.onClickCancel,onClickRight:()=>this.formulaInput.handleAccept(),header:a}:{menuType:k.og.Popup,width:580,height:o?"none":void 0,minHeight:358,disableScroller:!0,header:a,footer:this.renderStatus(),scrollerStyle:{display:"flex"}},d.createElement(P.Z,l,!o&&this.renderContent())}renderContent(){const{device:e}=this.environment,t=this.getLibrary(),i=this.getFocusedEntry(t);return e.isMobile?s()(W.Z,{initialFocus:0,context:{blocks:[],environment:this.environment,publicEditMode:void 0},filter:this.stores.formulaInputStore.state.query,sections:this.renderSections(t),menuListStore:this.stores.menuListStore,onFilteredSectionsChange:this.handleFilteredSectionsChange}):s()("div",{style:{display:"flex",flexGrow:1,boxShadow:`\n\t\t\t\t\t\t\tinset 0 1px 0 ${this.theme.regularDividerColor},\n\t\t\t\t\t\t\tinset 0 -1px 0 ${this.theme.regularDividerColor}\n\t\t\t\t\t\t`,maxHeight:295}},void 0,s()(B.Z,{type:I.Z.Y,style:{width:180,flexGrow:0,flexShrink:0}},void 0,s()(W.Z,{initialFocus:0,context:{blocks:[],environment:this.environment,publicEditMode:void 0},filter:this.stores.formulaInputStore.state.query,sections:this.renderSections(t),menuListStore:this.stores.menuListStore,onFilteredSectionsChange:this.handleFilteredSectionsChange})),s()(B.Z,{type:I.Z.Y,style:{padding:12,boxShadow:`inset 1px 0 0 ${this.theme.regularDividerColor}`,flexGrow:1}},void 0,s()(U,{entry:i})))}renderStatus(){const{device:e}=this.environment,{disabled:t}=this.props,{command:i}=C.fg(this.environment),{error:o}=this.stores.formulaInputStore.state;return o?s()("div",{style:e.isMobile?this.getMobileStatusWrapStyle():this.getDesktopStatusWrapStyle()},void 0,s()("span",{style:{...e.isMobile&&le.mobileStatusStyle,...le.errorStatusStyle}},void 0,o),!e.isMobile&&this.renderLearnMoreLink()):e.isMobile?s()("div",{style:this.getMobileStatusWrapStyle()},void 0,s()("span",{style:le.mobileStatusStyle},void 0,s()(v.FormattedMessage,{defaultMessage:"No errors.",id:"database.formula.mobileNoErrors.message"}))):t?void 0:s()("div",{style:this.getDesktopStatusWrapStyle()},void 0,s()("span",{},void 0,s()(v.FormattedMessage,{id:"database.formula.keyboardShortcutHint",defaultMessage:"{commandEnter} to accept",values:{commandEnter:s()("span",{style:{fontWeight:S.Z.fontWeight.medium}},void 0,i,"+Enter")}})),this.renderLearnMoreLink())}renderLearnMoreLink(){return s()("div",{style:{marginLeft:"auto"}},void 0,s()(ae.Z,{title:s()("span",{style:{fontSize:S.Z.fontSize.UISmall.desktop}},void 0,s()(v.FormattedMessage,{defaultMessage:"Learn more about formulas",id:"formulaPropertyMenu.learnMore.button.label"})),href:(0,T.UY)("guides.formulas"),analyticsFrom:"formula_property_menu"}))}renderSections(e){return e.map((e=>({key:e.key,title:this.props.intl.formatMessage(e.titleMessage),render:e=>d.createElement(N.Z,n()({},e,{desktopTitleStyle:{paddingLeft:8,paddingRight:8}})),actions:e.entries.map(((e,t)=>({key:this.getEntryKey(e,t),displayName:e.name,analyticsName:e.name,searchName:e.name,render:t=>d.createElement(J,n()({},t,{entry:e})),action:()=>{this.formulaInput.insertEntry(e)},closeParentMenu:!1})))})))}handleUpdate(e,t){const{onChange:i,schema:o,property:n,analyticsFrom:r}=this.props;if(e&&"error"===e.type);else{const s=o[n];i({propertySchema:{...s,formula:e},close:t}),s&&b.$qu(this.environment,{...(0,M.Pn)(this.context.collectionContextStore),property_type:s.type,action:"formula_edit",from:r})}}getLibrary(){const{schema:e,property:t,exampleBlock:i,intl:o}=this.props,n=Object.keys(e).filter((i=>{const o=e[i];return!(i===t||o&&h.rX.includes(o.type))})).map((t=>{const n=e[t];if(!n)throw new Error("Property not found.");const{name:r}=n,s=i?c.Qs({property:t,schema:e,block:f.kk.fromBlock(i),getRecordModel:w.default.getCurrentBlockModelFn(),userTimeZone:(0,y.r)(),intl:o,depth:0,resultCache:{},visitedProperties:new Set}):void 0;return{name:r,category:g.WD.property,fallbackDescription:o.formatMessage({id:"database.formula.property.description",defaultMessage:"Returns the {propertyName} property for each entry."},{propertyName:r}),resultType:m.z6(n),examples:s?[`prop(${JSON.stringify(r)}) == ${JSON.stringify(s)}`]:[]}}));return[g.jQ(g.WD.property,n),...g.ZY]}getFocusedEntry(e){var t;const{focus:{section:i,indexLocal:o}}=this.stores.menuListStore.state,n="number"==typeof i&&"number"==typeof o?null===(t=this.state.filteredSections[i])||void 0===t||null===(t=t.actions[o])||void 0===t?void 0:t.key:void 0;if(void 0!==n)for(const r of e)for(const[e,t]of r.entries.entries())if(this.getEntryKey(t,e)===n)return t}getEntryKey(e,t){return`${e.name} ${t}`}getDesktopStatusWrapStyle(){return{display:"flex",flex:"none",alignItems:"center",fontSize:12,paddingLeft:8,paddingRight:8,height:30,color:this.theme.mediumTextColor}}getMobileStatusWrapStyle(){const{WindowSizeStore:e}=this.environment;return{display:"flex",flex:"none",alignItems:"center",fontSize:14,height:28,color:this.theme.mediumTextColor,background:this.theme.popoverBackground,boxShadow:`0 1px 0 ${this.theme.regularDividerColor}`,paddingLeft:e.state.paddingLeftCSS,paddingRight:e.state.paddingRightCSS}}handleInputChange(e){this.handleUpdate(e,!1)}handleInputSubmit(e){this.handleUpdate(e,!0)}}le.displayName="FormulaPropertyMenu",le.contextTypes={...p.w,...x.xm},le.mobileStatusStyle={paddingLeft:16,paddingRight:16},le.errorStatusStyle={color:u.ZP.redWithAlpha(.8),...S.Z.textOverflowStyle};const de=(0,v.injectIntl)(le)}}]);